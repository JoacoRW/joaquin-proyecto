<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendar Espacio - Joaquín Proyecto</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .agenda-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .agenda-header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            text-align: center;
        }

        .calendar-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-nav {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
        }

        .calendar-nav:hover {
            background: #0056b3;
        }

        .calendar-nav:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
        }

        .calendar-day-header {
            text-align: center;
            font-weight: bold;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .calendar-day:hover {
            border-color: #007bff;
            background: #e7f3ff;
        }

        .calendar-day.disabled {
            color: #ccc;
            cursor: not-allowed;
            background: #f8f9fa;
        }

        .calendar-day.selected {
            background: #007bff;
            color: white;
            border-color: #0056b3;
        }

        .calendar-day.other-month {
            color: #ccc;
        }

        .time-slots-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .time-slots-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .time-slot {
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .time-slot:hover {
            border-color: #28a745;
            background: #e8f5e8;
        }

        .time-slot.selected {
            background: #28a745;
            color: white;
            border-color: #1e7e34;
        }

        .time-slot.occupied {
            background: #dc3545;
            color: white;
            cursor: not-allowed;
            border-color: #c82333;
        }

        .spaces-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .spaces-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .space-card {
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .space-card:hover {
            border-color: #17a2b8;
            transform: translateY(-2px);
        }

        .space-card.selected {
            border-color: #17a2b8;
            background: #e1f7fa;
        }

        .space-card.unavailable {
            border-color: #dc3545;
            background: #f8d7da;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .booking-summary {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .book-button {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s;
        }

        .book-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }

        .book-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .back-button {
            background: #6c757d;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
        }

        .back-button:hover {
            background: #545b62;
            text-decoration: none;
            color: white;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        @media (max-width: 768px) {
            .calendar-grid {
                font-size: 14px;
            }
            
            .time-slots-grid {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            }
            
            .spaces-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="agenda-container">
        <a href="dashboard.html" class="back-button">
            <i class="fas fa-arrow-left"></i>
            Volver al Dashboard
        </a>

        <div class="agenda-header">
            <h1><i class="fas fa-calendar-plus"></i> Agendar Espacio</h1>
            <p>Selecciona fecha, hora y espacio para realizar tu reserva</p>
        </div>

        <!-- Calendario -->
        <div class="calendar-container">
            <h2><i class="fas fa-calendar-alt"></i> Seleccionar Fecha</h2>
            <div class="calendar-header">
                <button class="calendar-nav" id="prevMonth">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <h3 id="currentMonth">Loading...</h3>
                <button class="calendar-nav" id="nextMonth">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            <div class="calendar-grid" id="calendarGrid">
                <!-- Calendar will be generated here -->
            </div>
        </div>

        <!-- Horarios -->
        <div class="time-slots-container" style="display: none;" id="timeSlotsContainer">
            <h2><i class="fas fa-clock"></i> Seleccionar Horario</h2>
            <p>Fecha seleccionada: <span id="selectedDate"></span></p>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                <div>
                    <h3><i class="fas fa-play"></i> Hora Inicio</h3>
                    <select id="horaInicio" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 16px;">
                        <option value="">Seleccionar hora inicio</option>
                    </select>
                </div>
                <div>
                    <h3><i class="fas fa-stop"></i> Hora Fin</h3>
                    <select id="horaFin" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 16px;">
                        <option value="">Seleccionar hora fin</option>
                    </select>
                </div>
            </div>
            
            <div id="timeConflictMessage" style="display: none; background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <i class="fas fa-exclamation-triangle"></i> Hay conflictos con reservas existentes en el horario seleccionado.
            </div>
        </div>

        <!-- Espacios -->
        <div class="spaces-container" style="display: none;" id="spacesContainer">
            <h2><i class="fas fa-building"></i> Seleccionar Espacio</h2>
            <p>Horario seleccionado: <span id="selectedTimeRange"></span></p>
            <div class="spaces-grid" id="spacesGrid">
                <!-- Spaces will be loaded here -->
            </div>
        </div>

        <!-- Resumen y Botón de Reserva -->
        <div class="booking-summary" style="display: none;" id="bookingSummary">
            <h3><i class="fas fa-clipboard-check"></i> Resumen de Reserva</h3>
            <div id="summaryDetails"></div>
            <button class="book-button" id="bookButton">
                <i class="fas fa-calendar-check"></i>
                Confirmar Reserva
            </button>
        </div>

        <!-- Debug button -->
        <div style="text-align: center; margin: 20px;">
            <button onclick="testAgendar()" style="background: #17a2b8; color: white; padding: 10px 20px; border: none; border-radius: 8px;">
                🔧 Test Agendar API
            </button>
        </div>

        <!-- Messages -->
        <div id="messages"></div>
    </div>

    <script>
        // Function to test agendar endpoint directly
        async function testAgendar() {
            const token = localStorage.getItem('idToken');
            if (!token) {
                alert('No hay token disponible');
                return;
            }

            try {
                console.log('Testing agendar endpoint...');
                
                const testData = {
                    espacioId: 'box1',
                    fecha: new Date().toISOString()
                };
                
                console.log('Sending data:', testData);
                console.log('Token:', token.substring(0, 50) + '...');
                
                const response = await fetch('https://2l83g90ljg.execute-api.us-east-1.amazonaws.com/dev/testAgendar', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testData)
                });

                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                    alert(`Error ${response.status}: ${errorText}`);
                    return;
                }

                const data = await response.json();
                console.log('Success response:', data);
                alert('✅ Test exitoso: ' + JSON.stringify(data));
                
            } catch (error) {
                console.error('Test error:', error);
                alert('❌ Test falló: ' + error.message);
            }
        }
    </script>

    <script>
        class AgendaApp {
            constructor() {
                this.selectedDate = null;
                this.selectedStartTime = null;
                this.selectedEndTime = null;
                this.selectedSpace = null;
                this.currentMonth = new Date();
                this.spaces = [];
                this.reservations = [];
                this.token = localStorage.getItem('idToken');
                
                this.initializeAuth();
                this.initializeCalendar();
                this.bindEvents();
                this.loadSpaces();
            }

            initializeAuth() {
                if (!this.token) {
                    alert('No estás autenticado. Redirigiendo al login...');
                    window.location.href = 'index.html';
                    return;
                }
            }

            initializeCalendar() {
                this.renderCalendar();
            }

            bindEvents() {
                document.getElementById('prevMonth').addEventListener('click', () => {
                    this.currentMonth.setMonth(this.currentMonth.getMonth() - 1);
                    this.renderCalendar();
                });

                document.getElementById('nextMonth').addEventListener('click', () => {
                    this.currentMonth.setMonth(this.currentMonth.getMonth() + 1);
                    this.renderCalendar();
                });

                document.getElementById('bookButton').addEventListener('click', () => {
                    this.bookSpace();
                });

                // Event listeners para los selectores de hora
                document.getElementById('horaInicio').addEventListener('change', () => {
                    this.onStartTimeChange();
                });

                document.getElementById('horaFin').addEventListener('change', () => {
                    this.onEndTimeChange();
                });
            }

            renderCalendar() {
                const grid = document.getElementById('calendarGrid');
                const monthHeader = document.getElementById('currentMonth');
                
                // Clear grid
                grid.innerHTML = '';
                
                // Month header
                const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                    'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                monthHeader.textContent = `${monthNames[this.currentMonth.getMonth()]} ${this.currentMonth.getFullYear()}`;
                
                // Day headers
                const dayNames = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];
                dayNames.forEach(day => {
                    const dayHeader = document.createElement('div');
                    dayHeader.className = 'calendar-day-header';
                    dayHeader.textContent = day;
                    grid.appendChild(dayHeader);
                });
                
                // Generate calendar days
                const firstDay = new Date(this.currentMonth.getFullYear(), this.currentMonth.getMonth(), 1);
                const lastDay = new Date(this.currentMonth.getFullYear(), this.currentMonth.getMonth() + 1, 0);
                const startDate = new Date(firstDay);
                startDate.setDate(startDate.getDate() - firstDay.getDay());
                
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                for (let i = 0; i < 42; i++) {
                    const currentDate = new Date(startDate);
                    currentDate.setDate(startDate.getDate() + i);
                    
                    const dayElement = document.createElement('div');
                    dayElement.className = 'calendar-day';
                    dayElement.textContent = currentDate.getDate();
                    
                    // Check if it's in current month
                    if (currentDate.getMonth() !== this.currentMonth.getMonth()) {
                        dayElement.classList.add('other-month');
                    }
                    
                    // Disable past dates
                    if (currentDate < today) {
                        dayElement.classList.add('disabled');
                    } else {
                        dayElement.addEventListener('click', () => {
                            this.selectDate(currentDate);
                        });
                    }
                    
                    grid.appendChild(dayElement);
                }

                // Update navigation buttons
                const prevButton = document.getElementById('prevMonth');
                const currentMonthStart = new Date(this.currentMonth.getFullYear(), this.currentMonth.getMonth(), 1);
                const todayMonthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                prevButton.disabled = currentMonthStart <= todayMonthStart;
            }

            async selectDate(date) {
                // Remove previous selection
                document.querySelectorAll('.calendar-day.selected').forEach(el => {
                    el.classList.remove('selected');
                });
                
                // Add selection to clicked date
                event.target.classList.add('selected');
                
                this.selectedDate = new Date(date);
                this.selectedStartTime = null;
                this.selectedEndTime = null;
                this.selectedSpace = null;
                
                // Load reservations for selected date
                await this.loadReservations(date);
                
                this.showTimeSlots();
                this.hideSpaces();
                this.hideSummary();
            }

            showTimeSlots() {
                const container = document.getElementById('timeSlotsContainer');
                const dateSpan = document.getElementById('selectedDate');
                
                dateSpan.textContent = this.selectedDate.toLocaleDateString('es-ES', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                this.populateTimeSelectors();
                container.style.display = 'block';
                container.scrollIntoView({ behavior: 'smooth' });
            }

            populateTimeSelectors() {
                const startSelect = document.getElementById('horaInicio');
                const endSelect = document.getElementById('horaFin');
                
                // Limpiar opciones existentes
                startSelect.innerHTML = '<option value="">Seleccionar hora inicio</option>';
                endSelect.innerHTML = '<option value="">Seleccionar hora fin</option>';
                
                // Generar opciones de 8:00 a 18:00 cada 30 minutos
                for (let hour = 8; hour <= 18; hour++) {
                    for (let minute of [0, 30]) {
                        if (hour === 18 && minute === 30) break;
                        
                        const timeString = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                        
                        // Verificar si está en el pasado para hoy
                        const now = new Date();
                        const slotDateTime = new Date(this.selectedDate);
                        slotDateTime.setHours(hour, minute, 0, 0);
                        
                        const isInPast = slotDateTime <= now;
                        
                        // Agregar opción para hora inicio
                        const startOption = document.createElement('option');
                        startOption.value = timeString;
                        startOption.textContent = timeString;
                        if (isInPast) {
                            startOption.disabled = true;
                            startOption.textContent += ' (pasado)';
                        }
                        startSelect.appendChild(startOption);
                        
                        // Agregar opción para hora fin (solo si no está en el pasado)
                        if (!isInPast) {
                            const endOption = document.createElement('option');
                            endOption.value = timeString;
                            endOption.textContent = timeString;
                            endSelect.appendChild(endOption);
                        }
                    }
                }
            }

            onStartTimeChange() {
                const startTime = document.getElementById('horaInicio').value;
                const endSelect = document.getElementById('horaFin');
                
                this.selectedStartTime = startTime;
                this.selectedEndTime = null;
                this.selectedSpace = null;
                
                if (startTime) {
                    // Actualizar opciones de hora fin para que sean después de la hora inicio
                    const [startHour, startMinute] = startTime.split(':').map(Number);
                    
                    // Limpiar y repoblar hora fin
                    endSelect.innerHTML = '<option value="">Seleccionar hora fin</option>';
                    
                    for (let hour = 8; hour <= 18; hour++) {
                        for (let minute of [0, 30]) {
                            if (hour === 18 && minute === 30) break;
                            
                            const timeString = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                            
                            // Solo mostrar horas después de la hora inicio
                            if (hour > startHour || (hour === startHour && minute > startMinute)) {
                                const option = document.createElement('option');
                                option.value = timeString;
                                option.textContent = timeString;
                                endSelect.appendChild(option);
                            }
                        }
                    }
                    
                    endSelect.disabled = false;
                } else {
                    endSelect.disabled = true;
                }
                
                this.checkTimeSlots();
                this.hideSpaces();
                this.hideSummary();
            }

            onEndTimeChange() {
                const endTime = document.getElementById('horaFin').value;
                this.selectedEndTime = endTime;
                
                if (this.selectedStartTime && this.selectedEndTime) {
                    this.checkTimeSlots();
                    this.showSpaces();
                } else {
                    this.hideSpaces();
                }
                
                this.hideSummary();
            }

            checkTimeSlots() {
                const messageDiv = document.getElementById('timeConflictMessage');
                
                if (!this.selectedStartTime || !this.selectedEndTime) {
                    messageDiv.style.display = 'none';
                    return;
                }
                
                // Verificar conflictos con reservas existentes
                const hasConflicts = this.hasTimeConflicts();
                
                if (hasConflicts) {
                    messageDiv.style.display = 'block';
                } else {
                    messageDiv.style.display = 'none';
                }
            }

            hasTimeConflicts() {
                if (!this.selectedStartTime || !this.selectedEndTime) return false;
                
                const [startHour, startMinute] = this.selectedStartTime.split(':').map(Number);
                const [endHour, endMinute] = this.selectedEndTime.split(':').map(Number);
                
                const selectedStart = new Date(this.selectedDate);
                selectedStart.setHours(startHour, startMinute, 0, 0);
                
                const selectedEnd = new Date(this.selectedDate);
                selectedEnd.setHours(endHour, endMinute, 0, 0);
                
                return this.reservations.some(reservation => {
                    const reservationDate = new Date(reservation.fecha);
                    
                    // Verificar si hay solapamiento de horarios
                    const reservationStart = new Date(reservationDate);
                    const reservationEnd = new Date(reservationDate);
                    reservationEnd.setMinutes(reservationEnd.getMinutes() + 30); // Asumiendo 30 min por defecto
                    
                    return (selectedStart < reservationEnd && selectedEnd > reservationStart);
                });
            }

            async loadSpaces() {
                try {
                    const response = await fetch('https://2l83g90ljg.execute-api.us-east-1.amazonaws.com/dev/listSpaces', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${this.token}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    this.spaces = data.spaces || [];
                } catch (error) {
                    console.error('Error loading spaces:', error);
                    this.showMessage('Error al cargar espacios: ' + error.message, 'error');
                }
            }

            async loadReservations(fecha) {
                try {
                    const fechaInicio = new Date(fecha);
                    fechaInicio.setHours(0, 0, 0, 0);
                    
                    const fechaFin = new Date(fecha);
                    fechaFin.setHours(23, 59, 59, 999);
                    
                    const response = await fetch(`https://2l83g90ljg.execute-api.us-east-1.amazonaws.com/dev/getReservas?fechaInicio=${fechaInicio.toISOString()}&fechaFin=${fechaFin.toISOString()}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${this.token}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    this.reservations = data.reservas || [];
                } catch (error) {
                    console.error('Error loading reservations:', error);
                    this.reservations = [];
                }
            }

            isTimeSlotOccupied(time) {
                const dateTime = new Date(this.selectedDate);
                const [hours, minutes] = time.split(':');
                dateTime.setHours(parseInt(hours), parseInt(minutes), 0, 0);
                
                return this.reservations.some(reservation => {
                    const reservationDate = new Date(reservation.fecha);
                    return Math.abs(reservationDate - dateTime) < 30 * 60 * 1000; // 30 minutos de diferencia
                });
            }

            isSpaceOccupied(spaceId) {
                if (!this.selectedTime || !this.selectedDate) return false;
                
                const dateTime = new Date(this.selectedDate);
                const [hours, minutes] = this.selectedTime.split(':');
                dateTime.setHours(parseInt(hours), parseInt(minutes), 0, 0);
                
                return this.reservations.some(reservation => {
                    const reservationDate = new Date(reservation.fecha);
                    return reservation.espacioId === spaceId && 
                           Math.abs(reservationDate - dateTime) < 30 * 60 * 1000; // 30 minutos de diferencia
                });
            }

            showSpaces() {
                const container = document.getElementById('spacesContainer');
                const timeSpan = document.getElementById('selectedTimeRange');
                
                timeSpan.textContent = `${this.selectedStartTime} - ${this.selectedEndTime}`;
                
                this.renderSpaces();
                container.style.display = 'block';
                container.scrollIntoView({ behavior: 'smooth' });
            }

            renderSpaces() {
                const grid = document.getElementById('spacesGrid');
                grid.innerHTML = '';
                
                if (this.spaces.length === 0) {
                    grid.innerHTML = '<div class="loading">No hay espacios disponibles</div>';
                    return;
                }
                
                this.spaces.forEach(space => {
                    const spaceCard = document.createElement('div');
                    spaceCard.className = 'space-card';
                    
                    const isSpaceOccupied = this.isSpaceOccupied(space.espacioId);
                    const isAvailable = space.disponible && !isSpaceOccupied;
                    
                    let statusText = 'Disponible';
                    let statusColor = '#28a745';
                    
                    if (!space.disponible) {
                        statusText = 'No Disponible';
                        statusColor = '#dc3545';
                    } else if (isSpaceOccupied) {
                        statusText = 'Ocupado en este horario';
                        statusColor = '#fd7e14';
                    }
                    
                    spaceCard.innerHTML = `
                        <h4><i class="fas fa-door-open"></i> ${space.espacioId}</h4>
                        <p><strong>Tipo:</strong> ${space.tipoEspacio}</p>
                        <p><strong>Descripción:</strong> ${space.descripcion}</p>
                        <p><strong>Estado:</strong> 
                            <span style="color: ${statusColor}">
                                ${statusText}
                            </span>
                        </p>
                    `;
                    
                    if (isAvailable) {
                        spaceCard.addEventListener('click', () => {
                            this.selectSpace(space);
                        });
                    } else {
                        spaceCard.classList.add('unavailable');
                    }
                    
                    grid.appendChild(spaceCard);
                });
            }

            selectSpace(space) {
                // Remove previous selection
                document.querySelectorAll('.space-card.selected').forEach(el => {
                    el.classList.remove('selected');
                });
                
                // Add selection to clicked space
                event.target.classList.add('selected');
                
                this.selectedSpace = space;
                this.showSummary();
            }

            showSummary() {
                const container = document.getElementById('bookingSummary');
                const details = document.getElementById('summaryDetails');
                
                details.innerHTML = `
                    <p><strong>📅 Fecha:</strong> ${this.selectedDate.toLocaleDateString('es-ES')}</p>
                    <p><strong>🕐 Horario:</strong> ${this.selectedStartTime} - ${this.selectedEndTime}</p>
                    <p><strong>🏢 Espacio:</strong> ${this.selectedSpace.espacioId}</p>
                    <p><strong>📝 Descripción:</strong> ${this.selectedSpace.descripcion}</p>
                    <p><strong>🏷️ Tipo:</strong> ${this.selectedSpace.tipoEspacio}</p>
                `;
                
                container.style.display = 'block';
                container.scrollIntoView({ behavior: 'smooth' });
            }

            async bookSpace() {
                const button = document.getElementById('bookButton');
                const originalText = button.innerHTML;
                
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
                
                try {
                    const dateTime = new Date(this.selectedDate);
                    const [startHours, startMinutes] = this.selectedStartTime.split(':');
                    dateTime.setHours(parseInt(startHours), parseInt(startMinutes));
                    
                    const response = await fetch('https://2l83g90ljg.execute-api.us-east-1.amazonaws.com/dev/agendarReserva', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            espacioId: this.selectedSpace.espacioId,
                            fecha: dateTime.toISOString(),
                            horaInicio: this.selectedStartTime,
                            horaFin: this.selectedEndTime
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `HTTP ${response.status}`);
                    }

                    const data = await response.json();
                    
                    this.showMessage('🎉 ¡Reserva confirmada exitosamente!', 'success');
                    
                    // Reset form
                    setTimeout(() => {
                        window.location.href = 'dashboard.html';
                    }, 2000);
                    
                } catch (error) {
                    console.error('Error booking space:', error);
                    this.showMessage('❌ Error al realizar la reserva: ' + error.message, 'error');
                    
                    button.disabled = false;
                    button.innerHTML = originalText;
                }
            }

            hideSpaces() {
                document.getElementById('spacesContainer').style.display = 'none';
            }

            hideSummary() {
                document.getElementById('bookingSummary').style.display = 'none';
            }

            showMessage(message, type) {
                const container = document.getElementById('messages');
                const messageDiv = document.createElement('div');
                messageDiv.className = type;
                messageDiv.textContent = message;
                
                container.innerHTML = '';
                container.appendChild(messageDiv);
                
                setTimeout(() => {
                    messageDiv.remove();
                }, 5000);
            }
        }

        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new AgendaApp();
        });
    </script>
</body>
</html>